<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>k23 Manual</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="intro.html">Intro</a></li><li class="chapter-item expanded "><a href="roadmap.html"><strong aria-hidden="true">1.</strong> Roadmap</a></li><li class="chapter-item expanded "><a href="memory_layout.html"><strong aria-hidden="true">2.</strong> Memory Layout</a></li><li class="chapter-item expanded "><a href="contributing.html"><strong aria-hidden="true">3.</strong> Contributing</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">k23 Manual</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="k23---experimental-wasm-operating-system"><a class="header" href="#k23---experimental-wasm-operating-system">k23 - Experimental WASM Operating System</a></h1>
<p>Welcome to the official <strong>k23 manual</strong>! This manual will guide you through the installation and usage of <em>k23</em>, an experimental WASM microkernel operating system.</p>
<br />
<p><strong>Watch my talk at RustNL 2024 about k23</strong></p>
<iframe width="560" height="315" src="https://www.youtube-nocookie.com/embed/GjDwj7RWOgs?si=bKBI4WKpm1HQ8YtP" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
<h2 id="what-is-k23"><a class="header" href="#what-is-k23">What is k23?</a></h2>
<p>k23 is an active research project exploring a <em>more secure, modular, and easy to develop for</em> operating system by using WebAssembly as the primary execution environment.
The project is still in its early stages and is not yet ready for production use.</p>
<h2 id="why"><a class="header" href="#why">Why?</a></h2>
<p>As the world has changed, so has the way we interact with computers. When UNIX was invented in the 1960s, the world was a very different place.
Time-sharing, the concept of multiple users sharing a single computer, was the hot new thing and having a wold-spanning connected system was a pipe dream. And while countless people have worked incredibly hard to adapt the old systems to the new world, it is clear that the old systems are not up to the task.</p>
<p>In todays massively interconnected world, where security is paramount maybe, <em>just maybe</em>, there is an opportunity for a new OS to rethink how we can build secure, scalable and understandable systems for the 21st century.</p>
<h2 id="how"><a class="header" href="#how">How?</a></h2>
<p>k23 is built around the idea of using WebAssembly as the primary execution environment. This allows for a number of benefits:</p>
<ul>
<li><strong>Security</strong>: WebAssembly is designed to run in a sandboxed environment, making it much harder to exploit.</li>
<li><strong>Modularity</strong>: WebAssembly modules can depend on each other, importing and exporting functionality and data, forming a modular system where dependency management is a <strong>first class citizen</strong>.</li>
<li><strong>Portability</strong>: WebAssembly is designed to be very portable. Forget questions like "is this binary compiled for amd64 or arm?". k23 programs just run wherever.</li>
<li><strong>Static Analysis</strong>: WebAssembly is famous for being very easy to analyze. This means we can check for bad programs without even running them.</li>
</ul>
<p>k23 also uses a microkernel architecture where only the most core kernel functionliaty and WASM runtime are running in privileged mode. Everything else is implemented as a WebAssembly module, running in a strongly sandboxed environment.</p>
<h3 id="the-jit-compiler"><a class="header" href="#the-jit-compiler">The JIT compiler</a></h3>
<p>The core thesis of k23 is that <strong>by directly integrating the compiler into the kernel, they enter into a symbiotic relationship</strong> where e.g. the kernels knowledge of the physical machine can inform specific optimization in the compiler and the total knowledge of all programs running on the system by the compiler can inform various sppedups in the kernel.
Cool stuff that only becomes possible because os this is:</p>
<ul>
<li><strong>Zero-cost IPC calls.</strong> By leveraging the total knowledge of all programs the kernel can reduce the cost of IPC calls to almost the cost of regular function calls.</li>
<li><strong>Machine specific optimizations</strong> The kernel knows the exacts capability of the machine, of each core and much more. Being tightly integrated allows for these details to feed into compiler optimization passes.</li>
<li><strong>Program aware scheduling</strong> The compiler collects information about each program such as instruction use, information about possibly hot loops etc. This information can be fed back into the scheduler to allow it to make more informed decisions, like using performance cores vs efficiency cores.</li>
</ul>
<p>k23 uses <a href="https://cranelift.dev">cranelift</a> as its JIT compiler backend.</p>
<h2 id="installation"><a class="header" href="#installation">Installation</a></h2>
<p>There are currently no pre-built binaries available. However, here are the steps to run it from source:</p>
<h2 id="prerequisites"><a class="header" href="#prerequisites">Prerequisites:</a></h2>
<ul>
<li><a href="https://www.rust-lang.org/tools/install">Rust</a></li>
<li><a href="https://just.systems">just</a></li>
<li><a href="https://www.qemu.org">QEMU</a></li>
</ul>
<h2 id="running"><a class="header" href="#running">Running</a></h2>
<p>Type <code>just</code> to see the available actions to run. The one you are probably looking for is <code>just run-riscv64</code> which will build k23 for <code>riscv64</code> and run it inside QEMU. Note that this is currently just running a few basic tests and exits.
Other actions include:</p>
<ul>
<li><code>just preflight</code> which will run all lints and checks</li>
<li><code>just test-riscv64</code> which will run all tests</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="roadmap"><a class="header" href="#roadmap">Roadmap</a></h1>
<p>There are <strong>plenty</strong> of things not yet implementing, missing, or broken. Here is a list of things that are planned to be implemented in the future:</p>
<ul>
<li><input disabled="" type="checkbox"/>
<strong>More of WASM</strong>: Support more WASM instructions and features.</li>
<li><input disabled="" type="checkbox"/>
<strong>Scheduler</strong>: Implement a scheduler to run multiple threads concurrently.</li>
<li><input disabled="" type="checkbox"/>
<strong>Debug Tooling</strong>: OS development should be fun and easy. Develop <em>k23</em> specific debug tooling to make working on the OS a breeze.</li>
<li><input disabled="" type="checkbox"/>
<strong>IPC</strong>: Implement Inter-Process Communication.</li>
<li><input disabled="" type="checkbox"/>
<strong>WASM Components</strong>: Support the WASM components proposal, a requirement for proper microkernel modularity.</li>
<li><input disabled="" type="checkbox"/>
<strong>Component Registry &amp; Basic Package Manager</strong>: Using the WASM components registry proposal, implement a basic package manager to install and run components dynamically.</li>
<li><input disabled="" type="checkbox"/>
<strong>Capability System</strong>: Implement a capability based security system for interacting with OS functionality and drivers</li>
<li><input disabled="" type="checkbox"/>
<strong>WASI Support</strong>: Support the WebAssembly System Interface specification for accessing things like the network, file system and more.</li>
</ul>
<p>This list is not exhaustive and will be updated as development progresses. If you would like to discuss the roadmap items above or have suggestions, please open a discussion on the <a href="https://github.com/JonasKruckenberg/k23">GitHub repository</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="chapter-1"><a class="header" href="#chapter-1">Chapter 1</a></h1>
<h2 id="virtual-memory-layout"><a class="header" href="#virtual-memory-layout">Virtual Memory Layout</a></h2>
<p>This page outlines the virtual memory layout used by <em>k23</em> depending on the selected memory mode.
Currently supported memory modes are <code>Riscv64Sv39</code>, <code>Riscv64Sv48</code> and <code>Riscv64Sv57</code>.
Note that addresses marked as <code>&lt;dynamic&gt;</code> are not fixed and depend on the number of harts (hardware threads) in the system.</p>
<p>The code implementing this memory layout can be found in <a href="../../loader/src/mapping.rs"><code>loader/src/mapping.rs</code></a>.</p>
<h3 id="sv39"><a class="header" href="#sv39">Sv39</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Address Range</th><th>Size</th><th>Description</th></tr></thead><tbody>
<tr><td>0x0000000000000000..=0x0000003fffffffff</td><td>256 GB</td><td>user-space virtual memory</td></tr>
<tr><td>0x0000004000000000..=0xffffffbfffffffff</td><td>~16K PB</td><td>hole of non-canonical virtual memory addresses</td></tr>
<tr><td></td><td></td><td>kernel-space virtual memory</td></tr>
<tr><td>0xffffffc000000000..=&lt;dynamic&gt;</td><td>~96 GB</td><td>unused</td></tr>
<tr><td>&lt;dynamic&gt;..=&lt;dynamic&gt;</td><td>&lt;dynamic&gt;</td><td>kernel stacks</td></tr>
<tr><td>&lt;dynamic&gt;..=0xffffffd7ffffffff</td><td>&lt;dynamic&gt;</td><td>kernel TLS (thread local storage)</td></tr>
<tr><td>0xffffffd800000000..=0xffffffe080000000</td><td>124 GB</td><td>direct mapping of all physical memory (PHYS_OFFSET)</td></tr>
<tr><td>0xffffffff80000000..=0xffffffffffffffff</td><td>2 GB</td><td>kernel (KERN_OFFSET)</td></tr>
</tbody></table>
</div>
<h3 id="sv48"><a class="header" href="#sv48">Sv48</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Address Range</th><th>Size</th><th>Description</th></tr></thead><tbody>
<tr><td>0x0000000000000000..=0x00007fffffffffff</td><td>128 TB</td><td>user-space virtual memory</td></tr>
<tr><td>0x0000800000000000..=0xffff7fffffffffff</td><td>~16K PB</td><td>hole of non-canonical virtual memory addresses</td></tr>
<tr><td></td><td></td><td>kernel-space virtual memory</td></tr>
<tr><td>0xffff800000000000..=0xffffbfff7ffefffe</td><td>~64 TB</td><td>unused</td></tr>
<tr><td>&lt;dynamic&gt;..=&lt;dynamic&gt;</td><td>&lt;dynamic&gt;</td><td>kernel stacks</td></tr>
<tr><td>&lt;dynamic&gt;..=0xffffbfff7fffffff</td><td>&lt;dynamic&gt;</td><td>kernel TLS (thread local storage)</td></tr>
<tr><td>0xffffbfff80000000..=0xffffffff7fffffff</td><td>64 TB</td><td>direct mapping of all physical memory (PHYS_OFFSET)</td></tr>
<tr><td>0xffffffff80000000..=0xffffffffffffffff</td><td>2 GB</td><td>kernel (KERN_OFFSET)</td></tr>
</tbody></table>
</div>
<h3 id="sv57"><a class="header" href="#sv57">Sv57</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Address Range</th><th>Size</th><th>Description</th></tr></thead><tbody>
<tr><td>0x0000000000000000..=0x00ffffffffffffff</td><td>64 PB</td><td>user-space virtual memory</td></tr>
<tr><td>0x0100000000000000..=0xfeffffffffffffff</td><td>~16K PB</td><td>hole of non-canonical virtual memory addresses</td></tr>
<tr><td></td><td></td><td>kernel-space virtual memory</td></tr>
<tr><td>0xff00000000000000..=0xff7fffff7ffefffe</td><td>~32 PB</td><td>unused</td></tr>
<tr><td>&lt;dynamic&gt;..=&lt;dynamic&gt;</td><td>&lt;dynamic&gt;</td><td>kernel stacks</td></tr>
<tr><td>&lt;dynamic&gt;..=0xff7fffff7fffffff</td><td>&lt;dynamic&gt;</td><td>kernel TLS (thread local storage)</td></tr>
<tr><td>0xff7fffff80000000..=0xffffffff7fffffff</td><td>32 PB</td><td>direct mapping of all physical memory (PHYS_OFFSET)</td></tr>
<tr><td>0xffffffff80000000..=0xffffffffffffffff</td><td>2 GB</td><td>kernel (KERN_OFFSET)</td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><h1 id="contributing"><a class="header" href="#contributing">Contributing</a></h1>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </div>
    </body>
</html>
